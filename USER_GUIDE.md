# 画像整列アプリ - ユーザーガイド

## はじめに

画像整列アプリは、複数の画像を指定した領域に基づいて自動的に整列させるWebアプリケーションです。OpenCV.jsを使用した特徴点マッチングにより、高精度な画像整列を実現します。このガイドでは、アプリケーションの使用方法を詳しく説明します。

## 目次

1. [アプリケーションの起動](#アプリケーションの起動)
2. [画像のアップロード](#画像のアップロード)
3. [画像の管理](#画像の管理)
4. [領域選択](#領域選択)
5. [画像変形](#画像変形)
6. [自動整列](#自動整列)
7. [トラブルシューティング](#トラブルシューティング)

## アプリケーションの起動

### 必要な環境
- モダンブラウザ（Chrome, Firefox, Safari, Edge）
- JavaScript有効
- インターネット接続（初回起動時のみ）

### 起動方法
1. アプリケーションのURLにアクセス
2. ブラウザが自動的にOpenCV.jsをダウンロード
3. ダウンロード完了後、アプリケーションが利用可能になります

## 画像のアップロード

### 対応形式
- JPEG (.jpg, .jpeg)
- PNG (.png)
- GIF (.gif)
- その他の一般的な画像形式

### アップロード方法

#### 方法1: ドラッグ&ドロップ
1. アプリケーションのアップロードエリアに画像ファイルをドラッグ
2. 複数の画像を同時にドラッグ可能
3. ドロップすると自動的にアップロードが開始

#### 方法2: ファイル選択
1. 「ファイルを選択」ボタンをクリック
2. ファイル選択ダイアログが開く
3. 複数の画像を選択（Ctrl+クリックで複数選択）
4. 「開く」をクリック

### ファイル名の順序

アプリケーションは、ファイル名から番号を自動抽出して処理順序を決定します。

#### 対応パターン
- `image1.jpg` → 1番目
- `image_001.jpg` → 1番目
- `image-01.jpg` → 1番目
- `image 1.jpg` → 1番目
- `photo123.jpg` → 123番目

#### 注意事項
- 番号が見つからない場合は0として扱われます
- 番号順に自動ソートされます
- 処理順序は画像リストの番号で確認できます

## 画像の管理

### 画像リスト

アップロードされた画像は、サイドバーの画像リストに表示されます。

#### 表示情報
- **画像番号**: 処理順序を示す番号
- **サムネイル**: 画像の縮小版
- **ファイル名**: 元のファイル名
- **サイズ**: 画像の幅×高さ
- **選択状態**: 領域選択済みかどうか

### 画像の選択

1. 画像リストの画像をクリック
2. 選択された画像がハイライト表示
3. 選択された画像がメインエリアに表示

### 画像の削除

1. 画像リストの「×」ボタンをクリック
2. 確認なしで即座に削除
3. 選択中の画像が削除された場合、次の画像が自動選択

## 領域選択

### 選択モードの切り替え

サイドバーの「領域選択モード」と「変形モード」を切り替えできます。

#### 領域選択モード
- 画像上で矩形領域を選択
- 整列の基準となる領域を指定

#### 変形モード
- 画像の変形パラメータを手動調整
- スライダーで細かい調整が可能

### 領域選択の手順

1. **画像選択**: 処理対象の画像を選択
2. **モード確認**: 「領域選択モード」になっていることを確認
3. **領域選択**: 画像上でマウスドラッグして矩形領域を選択
4. **確認**: 選択領域が緑色の枠で表示されることを確認

### 選択領域の調整

- **再選択**: 新しい領域を選択すると、前の選択が上書きされます
- **領域情報**: サイドバーに選択領域の座標情報が表示されます

### 選択領域の重要性

選択領域は整列処理の基準となるため、以下の点に注意してください：

- **共通の特徴**: すべての画像に存在する特徴的な領域を選択
- **十分な大きさ**: 小さすぎる領域は特徴点が不足する可能性
- **一貫性**: すべての画像で同じような領域を選択

## 画像変形

### 変形パラメータ

変形モードでは、以下のパラメータを調整できます：

#### スケール
- **範囲**: 0.1～3.0
- **刻み**: 0.1
- **機能**: 画像の拡大・縮小（表示用）

#### 回転
- **範囲**: -180度～180度
- **刻み**: 1度
- **機能**: 画像の回転

#### X位置
- **範囲**: -400px～400px
- **刻み**: 1px
- **機能**: 画像の左右移動

#### Y位置
- **範囲**: -300px～300px
- **刻み**: 1px
- **機能**: 画像の上下移動

### 変形の適用

1. **モード切り替え**: 「変形モード」に切り替え
2. **パラメータ調整**: スライダーで値を調整
3. **リアルタイム表示**: 調整結果がリアルタイムで表示
4. **リセット**: 「リセット」ボタンで初期値に戻す

### 画像サイズの保持

**重要**: 画像変換処理では、画像自体のサイズ（解像度、ピクセル数）は変更されません。変形パラメータは表示用であり、画像の本質的なサイズは保持されます。

## 自動整列

### 整列処理の種類

アプリケーションには3種類の整列処理があります：

#### 1. 自動整列
- **機能**: 選択領域の位置合わせと回転調整を順次実行
- **処理**: 
  - インデックス0の画像: 選択領域が画像中心に来るように変換
  - N>0の画像: 前の画像の選択領域と一致するように移動し、ORB特徴点マッチングで回転調整
- **用途**: 完全な自動整列が必要な場合

#### 2. 上下合わせ
- **機能**: 選択領域の位置合わせのみを実行
- **処理**: 移動変換のみで整列
- **用途**: 回転調整が不要な場合

#### 3. 回転調整
- **機能**: 選択領域の位置合わせが完了した画像に対して回転調整のみを実行
- **処理**: ORB特徴点マッチングによる精密な回転調整
- **用途**: 位置合わせ後に回転調整のみを行いたい場合

### 整列処理の実行

#### 前提条件
- **画像数**: 2枚以上の画像が必要
- **選択領域**: すべての画像に選択領域が設定されている必要

#### 実行手順
1. **画像アップロード**: 2枚以上の画像をアップロード
2. **領域選択**: すべての画像で整列基準となる領域を選択
3. **処理選択**: 実行したい整列処理を選択
4. **実行**: 対応するボタンをクリック
5. **完了待機**: 処理完了まで待機（処理中は「処理中...」と表示）

#### 処理中の表示
- ボタンが「処理中...」に変わる
- ボタンが無効化される
- 処理完了まで他の操作は無効

#### 完了通知
- 処理完了時にアラートで通知
- エラー発生時はエラーメッセージを表示

### 処理結果の確認

#### 視覚的確認
- 整列された画像がキャンバスに表示
- 選択領域が正しく整列されているか確認

#### 詳細確認
- ブラウザの開発者ツールでコンソールログを確認
- 処理の詳細情報が出力されます

### 画像サイズの保持

整列処理後も、画像自体のサイズ（解像度、ピクセル数）は元のまま保持されます。変換処理は画像の位置と回転のみを変更し、画像の本質的なサイズには影響しません。

## トラブルシューティング

### よくある問題と解決方法

#### 1. 画像がアップロードできない

**症状**: 画像をアップロードしても表示されない

**原因と解決方法**:
- **ファイル形式**: 対応していない形式の可能性
  - 解決: JPEG, PNG, GIF形式の画像を使用
- **ファイルサイズ**: ファイルが大きすぎる可能性
  - 解決: 画像サイズを小さくする
- **ブラウザの制限**: ブラウザの制限に引っかかっている可能性
  - 解決: 別のブラウザで試す

#### 2. 領域選択ができない

**症状**: 画像上でドラッグしても領域が選択されない

**原因と解決方法**:
- **モード確認**: 変形モードになっている可能性
  - 解決: 「領域選択モード」に切り替え
- **画像選択**: 画像が選択されていない可能性
  - 解決: 画像リストから画像を選択

#### 3. 整列処理が失敗する

**症状**: 整列処理でエラーが発生する

**原因と解決方法**:
- **画像数不足**: 2枚未満の画像しかない
  - 解決: 2枚以上の画像をアップロード
- **選択領域未設定**: 一部の画像に選択領域がない
  - 解決: すべての画像に選択領域を設定
- **特徴点不足**: 選択領域が小さすぎる
  - 解決: より大きな領域を選択
- **OpenCV未読み込み**: OpenCV.jsが読み込まれていない
  - 解決: ページを再読み込みしてOpenCV.jsの読み込みを待つ

#### 4. 画像が拡大されて表示される

**症状**: 整列処理後、画像が予想以上に大きく表示される

**原因と解決方法**:
- **表示スケール**: キャンバスサイズに合わせた表示スケールが適用されている
  - 解決: これは正常な動作です。画像自体のサイズは変更されていません
- **変換処理**: 画像変換処理では画像サイズは保持されます

#### 5. 選択領域の位置がずれる

**症状**: 整列処理後、選択領域の表示位置がずれる

**原因と解決方法**:
- **座標変換**: 変換後の画像で選択領域の座標変換が正しく行われていない
  - 解決: 選択領域を再選択する
- **表示スケール**: 表示スケールの変更により座標がずれる
  - 解決: これは正常な動作です。選択領域は画像座標系で正しく保存されています

### パフォーマンスの最適化

#### 画像サイズの推奨
- **推奨サイズ**: 1920x1080以下
- **最大サイズ**: 4096x4096以下
- **ファイルサイズ**: 10MB以下

#### 処理時間の目安
- **2枚の画像**: 1-3秒
- **5枚の画像**: 3-8秒
- **10枚の画像**: 8-15秒

### ブラウザの推奨設定

#### Chrome/Edge
- ハードウェアアクセラレーション有効
- WebGL有効

#### Firefox
- WebGL有効
- メモリ使用量制限を緩和

#### Safari
- JavaScript有効
- プライベートブラウジングモードを無効

## 技術的な詳細

### 画像処理の仕組み

#### 特徴点マッチング
- **アルゴリズム**: ORB (Oriented FAST and Rotated BRIEF)
- **特徴点抽出**: 画像から特徴的な点を自動抽出
- **マッチング**: 2つの画像間で対応する特徴点を検索
- **フィルタリング**: 距離フィルタリングと外れ値除去で精度向上

#### 最適化計算
- **回転最適化**: -30度から30度の範囲で0.5度刻みで探索
- **移動最適化**: 特徴点の対応関係から最適な移動量を計算
- **距離最小化**: 対応点間の距離の総和を最小化

### 座標系

#### 画像座標系
- **原点**: 画像の左上 (0, 0)
- **X軸**: 右方向が正
- **Y軸**: 下方向が正
- **単位**: ピクセル

#### キャンバス座標系
- **原点**: キャンバスの左上 (0, 0)
- **X軸**: 右方向が正
- **Y軸**: 下方向が正
- **単位**: ピクセル

### データ形式

#### 画像データ
- **形式**: Base64エンコードされたPNG
- **品質**: 元画像の品質を保持
- **サイズ**: 元画像のサイズを保持

#### 選択領域データ
- **形式**: 画像座標系での矩形座標
- **保存**: 画像ごとに独立して保存
- **更新**: 領域選択時に自動更新 